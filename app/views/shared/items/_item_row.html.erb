<%
the_item_path = if @superadmin
                  superadmin_company_team_user_item_path(@company, @team, @user, item)
                elsif @company.present?
                  company_owner_company_team_user_item_path(@company, @team, @user, item)
                elsif @team.present?
                  manager_team_user_item_path(@team, @user, item)
                else
                  my_item_path(item)
                end
%>

<tr id="<%= dom_id(item) %>" class="border-b border-gray-600 hover:bg-gray-700">
  <!-- NAME -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="name"
      data-cell-edit-initial-value-value="<%= item.name || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <%= item.name.presence || "-" %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <input
          type="text"
          class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white"
          data-cell-edit-target="input"
          value="<%= item.name %>"
          required
        >
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded"
        >
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- DESCRIPTION -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="description"
      data-cell-edit-initial-value-value="<%= item.description || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <%= item.description.presence || "-" %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <input
          type="text"
          class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white w-60"
          data-cell-edit-target="input"
          value="<%= item.description %>"
        >
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded"
        >
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- LINK -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="link"
      data-cell-edit-initial-value-value="<%= item.link || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <% if item.link.present? %>
          <a href="<%= item.link %>"
             target="_blank"
             class="underline text-blue-400"
             data-cell-edit-target="linkPreventer"
          >
            <%= item.link %>
          </a>
        <% else %>
          -
        <% end %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <input
          type="text"
          class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white w-64"
          data-cell-edit-target="input"
          value="<%= item.link %>"
        >
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded"
        >
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- REASON -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="reason"
      data-cell-edit-initial-value-value="<%= item.reason || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <%= item.reason.presence || "-" %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <input
          type="text"
          class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white w-60"
          data-cell-edit-target="input"
          value="<%= item.reason %>"
        >
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded"
        >
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- EXPECTED RESULTS -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="expected_results"
      data-cell-edit-initial-value-value="<%= item.expected_results || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <%= item.expected_results.presence || "-" %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <input
          type="text"
          class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white w-60"
          data-cell-edit-target="input"
          value="<%= item.expected_results %>"
        >
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded"
        >
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- CATEGORY -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="category"
      data-cell-edit-initial-value-value="<%= item.category || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <%= item.category.presence || "-" %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <input
          type="text"
          class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white w-60"
          data-cell-edit-target="input"
          value="<%= item.category %>"
        >
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded"
        >
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- EFFORT -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="effort"
      data-cell-edit-initial-value-value="<%= item.effort || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <%= effort_full_label(item.effort) %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <select data-cell-edit-target="input"
                class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white w-72"
                value="<%= item.effort %>"
        >
          <option value="">Select Effort</option>
          <option value="5">5 - Very Hard (10+ full-time days)</option>
          <option value="4">4 - Hard (5-10 full-time days)</option>
          <option value="3">3 - Medium (3-5 full-time days)</option>
          <option value="2">2 - Easy (2-3 full-time days)</option>
          <option value="1">1 - Very Easy (&lt;1 full-time day)</option>
        </select>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded">
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- PROGRESS (Progress Updates per ItemProgressColumn) -->
  <% progress_columns.each do |column| %>
    <% progress_update = item.progress_updates.find_by(item_progress_column: column) %>
    <% if progress_update %>
      <% progress_update_path = if @superadmin
                                  superadmin_company_team_user_item_item_progress_column_progress_update_path(@company, @team, @user, item, column, progress_update)
                                elsif @company.present?
                                  company_owner_company_team_user_item_item_progress_column_progress_update_path(@company, @team, @user, item, column, progress_update)
                                elsif @team.present?
                                  manager_team_user_item_item_progress_column_progress_update_path(@team, @user, item, column, progress_update)
                                else
                                  # my_user_item_progress_column_progress_update_path(@user, column, progress_update)
                                  root_path
                                end %>
      <% method = :patch %>
    <% else %>
      <% progress_update_path = if @superadmin
                                  superadmin_company_team_user_item_item_progress_column_progress_updates_path(@company, @team, @user, item, column)
                                elsif @company.present?
                                  company_owner_company_team_user_item_item_progress_column_progress_updates_path(@company, @team, @user, item, column)
                                elsif @team.present?
                                  manager_team_user_item_item_progress_column_progress_updates_path(@team, @user, item, column)
                                else
                                  # my_user_item_progress_column_progress_updates_path(@user, column)
                                  root_path
                                end %>
      <% method = :post %>
    <% end %>

    <td id="progress_update_<%= column.id %>_<%= item.id %>" class="px-4 py-2 align-top">
      <div
        class="cursor-pointer"
        data-controller="cell-edit"
        data-action="click->cell-edit#enableEdit"
        data-cell-edit-url-value="<%= progress_update_path %>"
        data-cell-edit-method-value="<%= method %>"
        data-cell-edit-field-name-value="percent"
        data-cell-edit-initial-value-value="<%= progress_update&.percent || '' %>"
        data-cell-edit-resource-name-value="progress_update"
        data-item-progress-column-id="<%= column.id %>"
      >
        <span data-cell-edit-target="display">
          <%= progress_update&.percent.present? ? "#{progress_update.percent}%" : "-" %>
        </span>
        <form
          data-cell-edit-target="form"
          class="hidden flex flex-col space-y-1 mt-1"
          data-action="submit->cell-edit#submit"
        >
          <input
            type="number"
            min="0"
            max="100"
            class="w-16 rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white"
            data-cell-edit-target="input"
            value="<%= progress_update&.percent || '' %>"
          >
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded">
            Save
          </button>
        </form>
      </div>
    </td>
  <% end %>

  <!-- RESULT -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="result"
      data-cell-edit-initial-value-value="<%= item.result || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <%= item.result.presence || "-" %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <input
          type="text"
          class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white w-60"
          data-cell-edit-target="input"
          value="<%= item.result %>"
        >
        <button
          type="submit"
          class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded"
        >
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- CERTIFICATE LINK -->
  <td class="px-4 py-2 align-top">
    <div
      class="cursor-pointer"
      data-controller="cell-edit"
      data-action="click->cell-edit#enableEdit"
      data-cell-edit-url-value="<%= the_item_path %>"
      data-cell-edit-field-name-value="certificate_link"
      data-cell-edit-initial-value-value="<%= item.certificate_link || '' %>"
      data-cell-edit-resource-name-value="item"
    >
      <span data-cell-edit-target="display">
        <% if item.certificate_link.present? %>
          <a href="<%= item.certificate_link %>"
             target="_blank"
             class="underline text-blue-400"
             data-cell-edit-target="linkPreventer"
          >
            <%= item.certificate_link %>
          </a>
        <% else %>
          -
        <% end %>
      </span>
      <form
        data-cell-edit-target="form"
        class="hidden flex flex-col space-y-1 mt-1"
        data-action="submit->cell-edit#submit"
      >
        <input
          type="text"
          class="rounded bg-gray-800 border border-gray-500 px-2 py-1 text-white w-60"
          data-cell-edit-target="input"
          value="<%= item.certificate_link %>"
        >
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded">
          Save
        </button>
      </form>
    </div>
  </td>

  <!-- ACTIONS (Delete Button) -->
  <td class="px-4 py-2 align-top text-right space-x-2">
    <%= link_to "Delete",
      the_item_path,
      data: { turbo_method: :delete, turbo_confirm: 'Are you sure?' },
      class: "bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" %>
  </td>
</tr>
